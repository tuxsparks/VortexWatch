<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro NEXRAD | Time-Dimension Playback</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.min.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0b0e11; color: white; }
        #map { height: 100vh; width: 100%; background: #0b0e11; }

        /* UI Panels */
        .panel {
            position: absolute; z-index: 1000;
            background: rgba(15, 15, 15, 0.9); border: 1px solid #444;
            padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .controls { top: 20px; left: 20px; width: 220px; }
        h2 { margin: 0 0 10px 0; font-size: 14px; color: #ffcc00; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .layer-item { display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; font-size: 13px; }
        .layer-item input { margin-right: 10px; }

        /* Radar Legend Styles */
        .legend { bottom: 30px; right: 20px; width: 180px; font-size: 11px; }
        .legend-title { font-weight: bold; margin-bottom: 8px; color: #ffcc00; display: block; text-align: center;}
        .legend-row { display: flex; align-items: center; margin-bottom: 4px; }
        .color-box { width: 30px; height: 12px; margin-right: 10px; border-radius: 2px; border: 1px solid rgba(255,255,255,0.2); }

        /* Time Dimension UI Overrides for Dark Mode */
        .leaflet-bar a { background-color: #222 !important; color: #fff !important; border-bottom: 1px solid #444 !important; }
        .leaflet-control-timedimension { background: rgba(15, 15, 15, 0.9) !important; color: white !important; border: 1px solid #444 !important; }
        
        #status { font-size: 10px; color: #00ffcc; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

<div class="panel controls">
    <h2>Radar Control</h2>
    <label class="layer-item"><input type="checkbox" id="toggle-radar" checked> Live NEXRAD (Loop)</label>
    <label class="layer-item"><input type="checkbox" id="toggle-warn" checked> Active NWS Warnings</label>
    <div id="status">Syncing Time...</div>
</div>

<div class="panel legend">
    <span class="legend-title">PRECIPITATION INTENSITY</span>
    <div class="legend-row"><div class="color-box" style="background: #9d15b0;"></div> Purple: Hail / Severe</div>
    <div class="legend-row"><div class="color-box" style="background: #ff0000;"></div> Red: Extreme</div>
    <div class="legend-row"><div class="color-box" style="background: #ff8c00;"></div> Orange: Very Heavy</div>
    <div class="legend-row"><div class="color-box" style="background: #0000ff;"></div> Blue: Heavy Rain</div>
    <div class="legend-row"><div class="color-box" style="background: #00ff00;"></div> Green: Moderate</div>
    <div class="legend-row"><div class="color-box" style="background: #ffff00;"></div> Yellow: Light Rain</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>

<script>
    // 1. Map Setup
    const map = L.map('map', {
        center: [38.5, -96.5],
        zoom: 5,
        zoomControl: false,
        timeDimension: true,
        timeDimensionOptions: {
            timeInterval: "PT2H/PRESENT", // Last 2 hours
            period: "PT5M",               // 5 minute increments
        },
        timeDimensionControl: true,
        timeDimensionControlOptions: {
            autoPlay: true,
            playerOptions: {
                transitionTime: 500,
                loop: true
            }
        }
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

    // 2. RDA Locations Array
    const rdaSites = [
        ["KABR", 45.4558, -98.4131], ["KENX", 42.5864, -74.0639], ["KABX", 35.1497, -106.8239],
        ["KILN", 39.4203, -83.8217], ["KCLE", 41.4131, -81.8597], ["KLVX", 37.9753, -85.9439],
        ["KLOT", 41.6047, -88.0847], ["KFWS", 32.5731, -97.3031], ["KFFC", 33.3636, -84.5658]
    ];

    rdaSites.forEach(s => {
        L.circleMarker([s[1], s[2]], {
            radius: 4, fillColor: "#333", color: "#666", weight: 1, fillOpacity: 0.8
        }).addTo(map).bindPopup(`<b>Station ID: ${s[0]}</b>`);
    });

    // 3. WMS Layers
    // Base Radar Layer
    const radarWMS = L.tileLayer.wms("https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi", {
        layers: 'nexrad-n0q-900913',
        format: 'image/png',
        transparent: true,
        opacity: 0.7,
        attribution: "IEM NEXRAD"
    });

    // Wrap Radar in TimeDimension
    const tdRadarLayer = L.timeDimension.layer.wms(radarWMS, {
        updateTimeDimension: true,
        requestTimeFromCapabilities: true
    });
    tdRadarLayer.addTo(map);

    // Live Warning Layer (IEM WMS - Pre-styled for accuracy)
    const warningLayer = L.tileLayer.wms("https://mesonet.agron.iastate.edu/cgi-bin/wms/uswarnings.cgi?", {
        layers: 'warnings_loop',
        format: 'image/png',
        transparent: true,
        opacity: 0.8,
        zIndex: 1000
    }).addTo(map);

    // 4. Interaction Logic
    document.getElementById('toggle-radar').addEventListener('change', (e) => {
        if (e.target.checked) tdRadarLayer.addTo(map);
        else map.removeLayer(tdRadarLayer);
    });

    document.getElementById('toggle-warn').addEventListener('change', (e) => {
        if (e.target.checked) warningLayer.addTo(map);
        else map.removeLayer(warningLayer);
    });

    // Auto-Refresh Logic (Every 2 mins)
    setInterval(() => {
        document.getElementById('status').innerText = "REFRESHING DATA...";
        warningLayer.redraw();
        // TimeDimension refreshes itself based on the presentation interval
        setTimeout(() => { document.getElementById('status').innerText = "SYSTEM: LIVE"; }, 2000);
    }, 120000);

    document.getElementById('status').innerText = "SYSTEM: LIVE";

</script>
</body>
</html>
