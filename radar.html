<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VortexWatch Radar | Live Radar Animation</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- TimeDimension CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-timedimension/1.1.0/leaflet.timedimension.control.min.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #0b0e11; color: white; }
        #map { height: 100vh; width: 100%; }

        .controls {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(15, 15, 15, 0.95); padding: 18px; border-radius: 10px;
            border: 1px solid #444; width: 220px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        h2 { margin: 0 0 15px 0; font-size: 14px; color: #ffcc00; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .section-label { font-size: 11px; color: #888; text-transform: uppercase; margin: 5px 0 8px 0; display: block; }
        
        .layer-control { 
            display: flex; align-items: center; width: 100%; background: #222; border: 1px solid #444; 
            color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 13px; 
            margin-bottom: 8px; box-sizing: border-box;
        }
        .layer-control input { margin-right: 12px; }

        #status { font-size: 10px; color: #00ffcc; margin-top: 10px; font-family: monospace; }

        .legend {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: rgba(0, 0, 0, 0.85); padding: 12px; border-radius: 8px;
            font-size: 11px; border: 1px solid #444; line-height: 1.6;
        }
        .warning-tag { display: inline-block; width: 12px; height: 12px; margin-right: 8px; border-radius: 2px; vertical-align: middle; }
        
        .leaflet-popup-content-wrapper { background: #111; color: white; border: 1px solid #444; }
        .leaflet-popup-tip { background: #111; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
    <h2>NWS RDA Monitor</h2>
    
    <span class="section-label">Map Overlays</span>
    <label class="layer-control"><input type="checkbox" id="check-radar" checked> Composite Radar</label>
    <label class="layer-control"><input type="checkbox" id="check-warn" checked> Active Warnings</label>
    
    <div id="status">System: Online</div>
</div>

<div class="legend">
    <b style="color:#ffcc00">RADAR LEGEND</b><br>
    <span class="warning-tag" style="background:#FFFF00"></span> Blank / No Precipitation<br>
    <span class="warning-tag" style="background:#00FF00"></span> Light Rain<br>
    <span class="warning-tag" style="background:#0000FF"></span> Moderate Rain<br>
    <span class="warning-tag" style="background:#FFA500"></span> Heavy Rain<br>
    <span class="warning-tag" style="background:#FF0000"></span> Very Heavy Rain<br>
    <span class="warning-tag" style="background:#8B00FF"></span> Extreme
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- TimeDimension JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-timedimension/1.1.0/leaflet.timedimension.min.js"></script>

<script>

    // 1. Initialize Map with TimeDimension
    const map = L.map('map', {
        center: [39.8, -98.5],
        zoom: 5,
        zoomControl: false,
        timeDimension: true,
        timeDimensionControl: true,
        timeDimensionControlOptions: {
            position: 'bottomleft',
            autoPlay: true,
            minSpeed: 1,
            maxSpeed: 10,
            speedStep: 1,
            timeSliderDragUpdate: true
        }
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    let radarLayer;
    let warningLayer;

    function addRadarTimeLayer() {
        if (radarLayer) map.removeLayer(radarLayer);
        if (!document.getElementById('check-radar').checked) return;

        radarLayer = L.tileLayer.wms('https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi?', {
            layers: 'nexrad-n0r-900913',
            format: 'image/png',
            transparent: true,
            opacity: 0.6,
            tileSize: 512
        });

        let tdLayer = L.timeDimension.layer.wms(radarLayer, {
            updateTimeDimension: true,
            setDefaultTime: true
        });

        tdLayer.addTo(map);
    }

    addRadarTimeLayer();

    // Warning layer
    warningLayer = L.geoJson(null, {
        style: (f) => {
            const e = f.properties.event || "";
            if (e.includes('Tornado')) return {color:'red', weight:3, fillOpacity:0.5};
            if (e.includes('Severe Thunderstorm')) return {color:'orange', weight:2, fillOpacity:0.4};
            if (e.includes('Flood')) return {color:'green', weight:2, fillOpacity:0.4};
            if (e.includes('Red Flag')) return {color:'#ff00ff', weight:2, fillOpacity:0.4};
            if (e.includes('Winter')) return {color:'#00ffff', weight:2, fillOpacity:0.4};
            return {color:'yellow', weight:1, fillOpacity:0.2};
        }
    }).addTo(map);

    async function fetchWarnings() {
        if (!document.getElementById('check-warn').checked) {
            warningLayer.clearLayers();
            return;
        }
        try {
            const res = await fetch('https://api.weather.gov/alerts/active');
            const data = await res.json();
            warningLayer.clearLayers().addData(data);
        } catch (e) { console.error("Warning error"); }
    }

    document.getElementById('check-radar').addEventListener('change', addRadarTimeLayer);
    document.getElementById('check-warn').addEventListener('change', fetchWarnings);

    fetchWarnings();
    setInterval(fetchWarnings, 60000);

</script>

</body>
</html>
