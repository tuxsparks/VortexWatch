<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXRAD RDA Monitor | Live Radar & Warnings</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- TimeDimension CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-timedimension/1.1.0/leaflet.timedimension.control.min.css" />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #0b0e11; color: white; }
        #map { height: 100vh; width: 100%; }

        .controls {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(15, 15, 15, 0.95); padding: 18px; border-radius: 10px;
            border: 1px solid #444; width: 220px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        h2 { margin: 0 0 15px 0; font-size: 14px; color: #ffcc00; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .section-label { font-size: 11px; color: #888; text-transform: uppercase; margin: 5px 0 8px 0; display: block; }

        .layer-control { 
            display: flex; align-items: center; width: 100%; background: #222; border: 1px solid #444; 
            color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 13px; 
            margin-bottom: 8px; box-sizing: border-box;
        }
        .layer-control input { margin-right: 12px; }

        #status { font-size: 10px; color: #00ffcc; margin-top: 10px; font-family: monospace; }

        .legend {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: rgba(0, 0, 0, 0.85); padding: 12px; border-radius: 8px;
            font-size: 11px; border: 1px solid #444; line-height: 1.6;
        }
        .warning-tag { display: inline-block; width: 12px; height: 12px; margin-right: 8px; border-radius: 2px; vertical-align: middle; }

        .leaflet-popup-content-wrapper { background: #111; color: white; border: 1px solid #444; }
        .leaflet-popup-tip { background: #111; }
    </style>
</head>
<body>

<div class="controls">
    <h2>NWS RDA Monitor</h2>
    
    <span class="section-label">Map Overlays</span>
    <label class="layer-control"><input type="checkbox" id="check-radar" checked> Composite Radar</label>
    <label class="layer-control"><input type="checkbox" id="check-warn" checked> Active Warnings</label>
    
    <div id="status">Source: IEM/NWS Hybrid</div>
</div>

<div class="legend">
    <b style="color:#ffcc00">WARNING PRIORITY</b><br>
    <span class="warning-tag" style="background:#FF0000"></span> Tornado (Bright Red)<br>
    <span class="warning-tag" style="background:#FFA500"></span> Severe T-Storm (Orange)<br>
    <span class="warning-tag" style="background:#00FF00"></span> Flash Flood (Green)<br>
    <span class="warning-tag" style="background:#FFFF00"></span> Special Marine (Yellow)
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- TimeDimension JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-timedimension/1.1.0/leaflet.timedimension.min.js"></script>

<script>
    // Initialize Map with TimeDimension
    const map = L.map('map', {
        center: [39.8, -98.5],
        zoom: 5,
        zoomControl: false,
        timeDimension: true,
        timeDimensionControl: true,
        timeDimensionControlOptions: {
            position: 'bottomleft',
            autoPlay: true,
            minSpeed: 1,
            maxSpeed: 10,
            speedStep: 1,
            timeSliderDragUpdate: true
        }
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    // RDA Station Data
    const rdaData = [
        ["14929","KABR","Aberdeen, SD",45.4558,-98.4131,"1302","20"],
        ["54766","KENX","Albany, NY",42.5864,-74.0639,"1826","20"],
        ["13841","KILN","Cincinnati, OH",39.4203,-83.8217,"1056","30"],
        ["14820","KCLE","Cleveland, OH",41.4131,-81.8597,"763","20"],
        ["53827","KLVX","Louisville, KY",37.9753,-85.9439,"719","30"],
        ["04833","KILX","Lincoln, IL",40.1506,-89.3369,"582","30"]
    ];

    rdaData.forEach(site => {
        L.circleMarker([site[3], site[4]], {
            radius: 5, fillColor: "#007bff", color: "#fff", weight: 1, fillOpacity: 0.8
        }).addTo(map).bindPopup(`<b>${site[1]}</b><br>${site[2]}<br>Elev: ${site[5]}ft`);
    });

    let radarLayer;
    let warningLayer;

    function addRadarTimeLayer() {
        if (radarLayer) map.removeLayer(radarLayer);
        if (!document.getElementById('check-radar').checked) return;

        radarLayer = L.tileLayer.wms('https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi?', {
            layers: 'nexrad-n0r-900913',
            format: 'image/png',
            transparent: true,
            opacity: 0.6,
            tileSize: 512
        });

        let tdLayer = L.timeDimension.layer.wms(radarLayer, {
            updateTimeDimension: true,
            setDefaultTime: true
        });

        tdLayer.addTo(map);
    }

    function addWarningsLayer() {
        if (warningLayer) map.removeLayer(warningLayer);
        if (!document.getElementById('check-warn').checked) return;

        warningLayer = L.tileLayer.wms('https://mesonet.agron.iastate.edu/cgi-bin/wms/uswarnings.cgi?', {
            layers: 'warnings_loop',
            format: 'image/png',
            transparent: true,
            opacity: 0.8,
            zIndex: 1000
        }).addTo(map);
    }

    document.getElementById('check-radar').addEventListener('change', addRadarTimeLayer);
    document.getElementById('check-warn').addEventListener('change', addWarningsLayer);

    addRadarTimeLayer();
    addWarningsLayer();

    setInterval(() => { addRadarTimeLayer(); addWarningsLayer(); }, 120000); // refresh every 2 min
</script>

</body>
</html>
